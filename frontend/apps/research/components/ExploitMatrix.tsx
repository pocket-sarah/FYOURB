
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Zap, ShieldAlert, Cpu, Activity, Globe, Lock, Unlock, Server } from 'lucide-react';

const MotionDiv = motion.div as any;

const ExploitMatrix: React.FC<{ onNotify: any }> = ({ onNotify }) => {
    const [isInfiltrating, setIsInfiltrating] = useState(false);
    const [progress, setProgress] = useState(0);
    const [logs, setLogs] = useState<string[]>([]);
    const [nodes, setNodes] = useState(Array.from({ length: 12 }).map((_, i) => ({
        id: `GATEWAY_${i + 1}`,
        status: 'SECURE',
        load: Math.floor(Math.random() * 20)
    })));

    const addLog = (msg: string) => setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev].slice(0, 10));

    const startInfiltration = () => {
        if (isInfiltrating) return;
        setIsInfiltrating(true);
        setProgress(0);
        setLogs([]);
        addLog(">> INITIATING POLYNOMIAL BRUTEFORCE...");
        addLog(">> BYPASSING FIREWALL_LAYER_1...");
    };

    useEffect(() => {
        if (isInfiltrating) {
            const interval = setInterval(() => {
                setProgress(prev => {
                    if (prev >= 100) {
                        clearInterval(interval);
                        setIsInfiltrating(false);
                        onNotify("Grid Compromised", "Access granted to central ledger.", "https://cdn-icons-png.flaticon.com/512/3953/3953226.png");
                        return 100;
                    }
                    const next = prev + 1;
                    if (next % 10 === 0) {
                        addLog(`>> PENETRATING NODE CLUSTER ${Math.floor(next/10)}... SUCCESS`);
                        setNodes(nodes => nodes.map((n, i) => i === Math.floor(next/10) ? { ...n, status: 'BREACHED', load: 99 } : n));
                    }
                    return next;
                });
            }, 150);
            return () => clearInterval(interval);
        }
    }, [isInfiltrating]);

    return (
        <div className="h-full flex flex-col p-6 gap-6 overflow-hidden bg-black text-[#ff003c] font-mono">
            {/* Header */}
            <div className="flex justify-between items-center bg-[#1a0005] p-5 rounded-[32px] border border-[#ff003c]/20">
                <div className="flex items-center gap-4">
                    <div className="p-3 rounded-2xl bg-[#ff003c]/10 text-[#ff003c]">
                        <Zap size={24} fill="currentColor" />
                    </div>
                    <div>
                        <h2 className="text-xl font-black uppercase tracking-widest">Infiltration Matrix</h2>
                        <p className="text-[10px] opacity-40 uppercase tracking-[0.2em]">Autonomous Exploit Engine v4.0</p>
                    </div>
                </div>
                <button 
                    onClick={startInfiltration}
                    disabled={isInfiltrating}
                    className="px-8 py-3 bg-[#ff003c] text-white rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-[#ff003c]/20 disabled:opacity-30 active:scale-95 transition-all"
                >
                    {isInfiltrating ? 'INFILTRATING...' : 'EXECUTE_ATTACK'}
                </button>
            </div>

            <div className="flex-1 flex flex-col gap-6 min-h-0">
                {/* Progress Bar */}
                <div className="space-y-2">
                    <div className="flex justify-between items-center px-1">
                        <span className="text-[9px] font-black uppercase opacity-40">System Compromise Progress</span>
                        <span className="text-sm font-black">{progress}%</span>
                    </div>
                    <div className="h-2 w-full bg-zinc-900 rounded-full overflow-hidden border border-[#ff003c]/10">
                        <MotionDiv 
                            animate={{ width: `${progress}%` }} 
                            className="h-full bg-[#ff003c] shadow-[0_0_20px_#ff003c]" 
                        />
                    </div>
                </div>

                <div className="flex-1 grid grid-cols-3 md:grid-cols-4 gap-4 overflow-y-auto no-scrollbar">
                    {nodes.map((node, i) => (
                        <div 
                            key={i}
                            className={`p-4 rounded-2xl border transition-all duration-500 flex flex-col gap-3 relative overflow-hidden ${
                                node.status === 'BREACHED' ? 'bg-[#ff003c]/10 border-[#ff003c] shadow-[0_0_15px_rgba(255,0,60,0.2)]' : 'bg-zinc-900/60 border-white/5'
                            }`}
                        >
                            <div className="flex justify-between items-start">
                                <span className="text-[8px] font-black opacity-30 tracking-tighter">{node.id}</span>
                                {node.status === 'BREACHED' ? <Unlock size={12} /> : <Lock size={12} className="opacity-20" />}
                            </div>
                            <div className="flex items-center gap-2">
                                <Server size={20} className={node.status === 'BREACHED' ? 'text-white' : 'opacity-20'} />
                                <span className={`text-[10px] font-black ${node.status === 'BREACHED' ? 'text-white' : 'opacity-20'}`}>{node.status}</span>
                            </div>
                            <div className="mt-auto flex flex-col gap-1">
                                <div className="h-0.5 w-full bg-white/5 rounded-full overflow-hidden">
                                    <div className="h-full bg-[#ff003c]" style={{ width: `${node.load}%` }} />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Live Console Logs */}
                <div className="h-32 bg-black border border-[#ff003c]/10 rounded-[32px] p-5 font-mono text-[10px] flex flex-col gap-1 shadow-inner relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-[0.03]">
                        <Activity size={60} />
                    </div>
                    {logs.map((log, i) => (
                        <div key={i} className={`flex gap-3 ${i === 0 ? 'text-white font-bold' : 'opacity-40'}`}>
                            <span className="shrink-0">>></span>
                            <p>{log}</p>
                        </div>
                    ))}
                    {logs.length === 0 && <p className="opacity-10 uppercase tracking-widest text-center mt-6">Awaiting execution parameters...</p>}
                </div>
            </div>
        </div>
    );
};

export default ExploitMatrix;
